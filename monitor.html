<!DOCTYPE html>
<html lang="en">

<head>
   <meta charset="UTF-8">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">
   <title>Live Visitor Monitor - Prajwal Chawda</title>
   <style>
      body {
         background: #0a0a0a;
         color: #00ff41;
         font-family: 'JetBrains Mono', monospace;
         margin: 0;
         padding: 20px;
      }

      .monitor-container {
         max-width: 1200px;
         margin: 0 auto;
      }

      .monitor-header {
         text-align: center;
         margin-bottom: 30px;
      }

      .status-grid {
         display: grid;
         grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
         gap: 20px;
         margin-bottom: 30px;
      }

      .status-card {
         background: rgba(0, 255, 65, 0.1);
         border: 1px solid #00ff41;
         border-radius: 8px;
         padding: 20px;
      }

      .status-card h3 {
         margin-top: 0;
         color: #00ff41;
      }

      .metric {
         font-size: 2em;
         font-weight: bold;
         color: #ffffff;
      }

      .activity-feed {
         background: rgba(0, 255, 65, 0.05);
         border: 1px solid #00ff41;
         border-radius: 8px;
         padding: 20px;
         height: 400px;
         overflow-y: auto;
      }

      .activity-item {
         padding: 10px;
         margin: 5px 0;
         background: rgba(0, 255, 65, 0.1);
         border-left: 3px solid #00ff41;
         border-radius: 4px;
      }

      .activity-item.new {
         animation: glow 1s ease-in-out;
      }

      .timestamp {
         color: #666;
         font-size: 0.8em;
      }

      .online-indicator {
         display: inline-block;
         width: 10px;
         height: 10px;
         background: #00ff41;
         border-radius: 50%;
         animation: pulse 2s infinite;
      }

      @keyframes pulse {
         0% {
            opacity: 1;
         }

         50% {
            opacity: 0.5;
         }

         100% {
            opacity: 1;
         }
      }

      @keyframes glow {
         0% {
            box-shadow: 0 0 5px #00ff41;
         }

         50% {
            box-shadow: 0 0 20px #00ff41;
         }

         100% {
            box-shadow: 0 0 5px #00ff41;
         }
      }

      .alert-sound {
         display: none;
      }
   </style>
</head>

<body>
   <div class="monitor-container">
      <div class="monitor-header">
         <h1>üîç Live Portfolio Monitor</h1>
         <p><span class="online-indicator"></span> Real-time Visitor Tracking Active</p>
      </div>

      <div class="status-grid">
         <div class="status-card">
            <h3>üìä Today's Stats</h3>
            <div class="metric" id="todayVisitors">0</div>
            <p>Total Visitors</p>
         </div>

         <div class="status-card">
            <h3>üíå Contact Forms</h3>
            <div class="metric" id="contactForms">0</div>
            <p>New Messages</p>
         </div>

         <div class="status-card">
            <h3>üîó Project Views</h3>
            <div class="metric" id="projectViews">0</div>
            <p>Project Interactions</p>
         </div>

         <div class="status-card">
            <h3>üë• Active Now</h3>
            <div class="metric" id="activeVisitors">0</div>
            <p>Current Visitors</p>
         </div>
      </div>

      <div class="activity-feed">
         <h3>üö® Live Activity Feed</h3>
         <div id="activityList">
            <div class="activity-item">
               <strong>Monitor Started</strong><br>
               Waiting for visitor activity...<br>
               <span class="timestamp">Just now</span>
            </div>
         </div>
      </div>
   </div>

   <audio class="alert-sound" id="alertSound" preload="auto">
      <source
         src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmccBCeB0PPYjC8JFGm98OOpXw8MU6rq8lqgRgkdG4PQtW9bFgRUdcvHzGwtBAEIBCtYAQoMDwc4AQsNEwg5AQwOFgg+AQ0OGwg8AQ4OGwk+AQ8PFAhAARAPGAo9ARANGgk9ARIRGwm7qeUABAAA"
         type="audio/wav">
   </audio>

   <script type="module">
      import { supabase, PortfolioDatabase } from './supabase-config.js';

      class LiveMonitor {
         constructor() {
            this.db = new PortfolioDatabase();
            this.activityList = document.getElementById('activityList');
            this.alertSound = document.getElementById('alertSound');
            this.stats = {
               todayVisitors: 0,
               contactForms: 0,
               projectViews: 0,
               activeVisitors: 0
            };

            this.init();
         }

         async init() {
            await this.loadTodayStats();
            this.startRealTimeTracking();
            this.updateActiveVisitors();

            // Update active visitors every 30 seconds
            setInterval(() => this.updateActiveVisitors(), 30000);
         }

         async loadTodayStats() {
            try {
               const today = new Date().toISOString().split('T')[0];

               // Get today's page views
               const { data: pageViews } = await supabase
                  .from('page_views')
                  .select('*')
                  .gte('viewed_at', today + 'T00:00:00');

               // Get today's contact forms
               const { data: contacts } = await supabase
                  .from('contact_submissions')
                  .select('*')
                  .gte('submitted_at', today + 'T00:00:00');

               // Get today's project interactions
               const { data: projects } = await supabase
                  .from('project_interactions')
                  .select('*')
                  .gte('clicked_at', today + 'T00:00:00');

               this.stats.todayVisitors = pageViews?.length || 0;
               this.stats.contactForms = contacts?.length || 0;
               this.stats.projectViews = projects?.length || 0;

               this.updateStatsDisplay();
            } catch (error) {
               console.error('Error loading stats:', error);
            }
         }

         updateStatsDisplay() {
            document.getElementById('todayVisitors').textContent = this.stats.todayVisitors;
            document.getElementById('contactForms').textContent = this.stats.contactForms;
            document.getElementById('projectViews').textContent = this.stats.projectViews;
            document.getElementById('activeVisitors').textContent = this.stats.activeVisitors;
         }

         async updateActiveVisitors() {
            try {
               const fiveMinutesAgo = new Date(Date.now() - 5 * 60 * 1000).toISOString();

               const { data: recentViews } = await supabase
                  .from('page_views')
                  .select('ip_address')
                  .gte('viewed_at', fiveMinutesAgo);

               const uniqueIPs = new Set(recentViews?.map(v => v.ip_address) || []);
               this.stats.activeVisitors = uniqueIPs.size;
               this.updateStatsDisplay();
            } catch (error) {
               console.error('Error updating active visitors:', error);
            }
         }

         startRealTimeTracking() {
            // Track page views
            supabase
               .channel('page-views')
               .on('postgres_changes',
                  { event: 'INSERT', schema: 'public', table: 'page_views' },
                  (payload) => this.handleNewPageView(payload.new)
               )
               .subscribe();

            // Track contact submissions
            supabase
               .channel('contact-submissions')
               .on('postgres_changes',
                  { event: 'INSERT', schema: 'public', table: 'contact_submissions' },
                  (payload) => this.handleNewContact(payload.new)
               )
               .subscribe();

            // Track project interactions
            supabase
               .channel('project-interactions')
               .on('postgres_changes',
                  { event: 'INSERT', schema: 'public', table: 'project_interactions' },
                  (payload) => this.handleNewProjectInteraction(payload.new)
               )
               .subscribe();
         }

         handleNewPageView(data) {
            this.stats.todayVisitors++;
            this.updateStatsDisplay();

            this.addActivity('üìÑ Page View', `Someone visited: ${data.page}`, data.viewed_at);
            this.playAlertSound();
         }

         handleNewContact(data) {
            this.stats.contactForms++;
            this.updateStatsDisplay();

            this.addActivity('üíå New Contact!', `${data.name} (${data.email}) sent a message`, data.submitted_at, true);
            this.playAlertSound();

            // Show browser notification
            if (Notification.permission === 'granted') {
               new Notification('New Portfolio Contact!', {
                  body: `${data.name} sent you a message`,
                  icon: '/profile.jpeg'
               });
            }
         }

         handleNewProjectInteraction(data) {
            this.stats.projectViews++;
            this.updateStatsDisplay();

            this.addActivity('üîó Project Click', `Someone clicked: ${data.project_name} (${data.interaction_type})`, data.clicked_at);
            this.playAlertSound();
         }

         addActivity(title, description, timestamp, important = false) {
            const activityItem = document.createElement('div');
            activityItem.className = `activity-item ${important ? 'important' : ''} new`;

            activityItem.innerHTML = `
                    <strong>${title}</strong><br>
                    ${description}<br>
                    <span class="timestamp">${new Date(timestamp).toLocaleString()}</span>
                `;

            this.activityList.insertBefore(activityItem, this.activityList.firstChild);

            // Remove the 'new' class after animation
            setTimeout(() => activityItem.classList.remove('new'), 1000);

            // Keep only last 50 items
            while (this.activityList.children.length > 50) {
               this.activityList.removeChild(this.activityList.lastChild);
            }
         }

         playAlertSound() {
            try {
               this.alertSound.currentTime = 0;
               this.alertSound.play().catch(e => console.log('Audio play failed:', e));
            } catch (error) {
               console.log('Audio not supported');
            }
         }
      }

      // Request notification permission
      if ('Notification' in window && Notification.permission === 'default') {
         Notification.requestPermission();
      }

      // Start monitoring
      new LiveMonitor();
   </script>
</body>

</html>